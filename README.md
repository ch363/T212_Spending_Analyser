# T212 Spending Analyser

Stage 1 delivers a deterministic synthetic debit card ledger with 10k baseline rows,
alongside the Streamlit experience, KPI layer, and optional LLM summary from Stage 0.

## Quick start üöÄ

```bash
python3.11 -m venv .venv
source .venv/bin/activate
pip install -e '.[dev]'
streamlit run app.py
```

Open the URL that Streamlit prints to explore the **Spending Analyser** dashboard. Use the
sidebar to tune the RNG seed, control sample size, or download both the 200-row preview and
the canonical 10k-row CSV generated by Stage 1.

## Features included

- üí∏ **Stage 1 generator** (`src/synth.py`) with seeded RNG, pay-cycle modelling, refunds, FX notes, and realistic merchant catalogue.
- ‚úèÔ∏è Feature engineering helpers adding recurring flags, monthly cohort stats, and share-of-wallet metrics (`src/features.py`).
- üìä KPI and aggregation utilities with debit/credit breakdown and net cashflow (`src/insights.py`).
- üìà Plotly visuals for monthly spend trends (`src/viz.py`).
- ü§ñ LLM summary wrapper with graceful local fallback (`src/summarize.py`).
- üß∞ Shared helpers for dataframe handling and formatting (`src/utils.py`).

## Tooling & scripts

- **Run the app:** `streamlit run app.py`
- **Unit tests:** `pytest`
- **Lint:** `ruff check .`
- **Format:** `ruff format .` or `black .`
- **Pre-commit hooks:** `pre-commit install`
- **Regenerate CSVs:** `python -m src.synth` (writes to `data/`)

All commands assume an activated virtual environment.

## Configuring the OpenAI summary

Set an API key to enable hosted LLM summaries:

```bash
export OPENAI_API_KEY="sk-..."
```

Without the key the app falls back to a deterministic text summary powered by local KPIs.
You can swap the client inside `src/summarize.py` for another provider if needed.

## Project layout

```
app.py                  # Streamlit entry point
data/schema.md          # Expected transaction columns
src/                    # Core business logic modules
tests/                  # Pytest-based regression suite
.streamlit/config.toml  # Optional theme configuration
```

See `data/schema.md` for the living contract of the transaction payload.

## Data schema snapshot

See `data/schema.md` for the full table. Key highlights from the Stage 1 output:

| Column | Example | Notes |
| --- | --- | --- |
| `txn_id` | `10d58214-c439-...` | Deterministic UUIDv4 per row. |
| `posted_date` | `2024-01-01` | Ledger posting date. |
| `value_date` | `2024-01-02` | Banking value date with weekend roll-forward. |
| `merchant_name` | `Tesco` | Merchant from curated catalogue (MCC aware). |
| `amount` | `-42.15` | Debits negative, credits/refunds positive. |
| `currency` | `GBP` | Includes occasional `USD` / `EUR` FX transactions. |
| `balance_after` | `2475.32` | Running balance seeded from ¬£2,500. |
| `recurring_id` | `rec_19f70fbcce` | Present for subscriptions/bills, `NA` otherwise. |
| `notes` | `FX purchase 86.12 USD @ rate 1.28` | Optional annotations (FX, refunds). |

## Next steps

- Hook the generator up to bank/CSV ingestion pathways.
- Extend insights for savings rate, category budgets, and alerting.
- Add richer filtering (multi-user, currency, merchant drill-downs).
- Explore retrieval-augmented LLM summaries grounded in historic trends.
