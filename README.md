# T212 Spending Analyser

Stage 3 adds bank-app-style visualisations and filters on top of the deterministic Stage 1
ledger and Stage 2 KPI engine: net-flow dashboards, category drill-downs, anomaly
surfacing, and interactive controls that pivot the entire app by date and currency.

## Quick start 🚀

```bash
python3.11 -m venv .venv
source .venv/bin/activate
pip install -e '.[dev]'
streamlit run app.py
```

Open the URL that Streamlit prints to explore the **Spending Analyser** dashboard. Use the
sidebar to tune the RNG seed, control sample size, or download both the 200-row preview and
the canonical 10k-row CSV generated by the deterministic ledger.

## Features included

- 💸 **Synthetic generator** (`src/synth.py`) with seeded RNG, pay-cycle modelling, refunds, FX notes, and realistic merchant catalogue.
- ✏️ Feature engineering helpers adding recurring flags, spend classifications (fixed/variable, essentials/discretionary), and share-of-wallet metrics (`src/features.py`).
- 📊 Stage 2 KPI engine with multi-window top categories, cash projection, payday countdown, recurring payment deltas, anomaly detection, and category splits (`src/insights.py`).
- 📈 Stage 3 charts and interactions: monthly net flow, month-to-date projection, category donut with merchant drill-down, recurring change badges, and outlier scatter (`src/viz.py`, `app.py`).
- 🎯 Sidebar filters including quick date presets, custom date pickers, and currency toggles that rehydrate every chart (`app.py`).
- 🤖 LLM summary wrapper with graceful local fallback (`src/summarize.py`).
- 🧰 Shared helpers for dataframe handling and formatting (`src/utils.py`).

## Stage 3 visualisations & UX

- 📊 **Monthly net flow** — stacked income vs spend bars with a net overlay for month-on-month context.
- 📈 **Month-to-date projection** — cumulative spend line extended with a projected burn curve.
- 🍩 **Category donut + drill-down** — share-of-wallet overview with instant merchant breakdowns for the selected slice.
- 🔁 **Recurring payment badges** — change indicators and status tags (on-track, missed, extra) for subscriptions and bills.
- 🚨 **Outlier scatter** — merchant scatter plot with anomalous purchases highlighted using z-scores.
- 🎛️ **Filters** — quick date presets (This month, Last month, YTD, All time), a custom date picker, and a currency toggle that rehydrates every chart.

## Tooling & scripts

- **Run the app:** `streamlit run app.py`
- **Unit tests:** `pytest`
- **Lint:** `ruff check .`
- **Format:** `ruff format .` or `black .`
- **Pre-commit hooks:** `pre-commit install`
- **Regenerate CSVs:** `python -m src.synth` (writes to `data/`)
- **Print KPI payload:** `python scripts/print_kpis.py`

All commands assume an activated virtual environment.

## Configuring the OpenAI summary

Set an API key to enable hosted LLM summaries:

```bash
export OPENAI_API_KEY="sk-..."
```

Without the key the app falls back to a deterministic text summary powered by local KPIs.
You can swap the client inside `src/summarize.py` for another provider if needed.

## Project layout

```
app.py                  # Streamlit entry point
data/schema.md          # Expected transaction columns
src/                    # Core business logic modules
tests/                  # Pytest-based regression suite
.streamlit/config.toml  # Optional theme configuration
```

See `data/schema.md` for the living contract of the transaction payload.

## Data schema snapshot

See `data/schema.md` for the full table. Key highlights from the Stage 1 output:

| Column | Example | Notes |
| --- | --- | --- |
| `txn_id` | `10d58214-c439-...` | Deterministic UUIDv4 per row. |
| `posted_date` | `2024-01-01` | Ledger posting date. |
| `value_date` | `2024-01-02` | Banking value date with weekend roll-forward. |
| `merchant_name` | `Tesco` | Merchant from curated catalogue (MCC aware). |
| `amount` | `-42.15` | Debits negative, credits/refunds positive. |
| `currency` | `GBP` | Includes occasional `USD` / `EUR` FX transactions. |
| `balance_after` | `2475.32` | Running balance seeded from £2,500. |
| `recurring_id` | `rec_19f70fbcce` | Present for subscriptions/bills, `NA` otherwise. |
| `notes` | `FX purchase 86.12 USD @ rate 1.28` | Optional annotations (FX, refunds). |

### Engineered fields snapshot

Stage 2 feature engineering injects additional columns used by the KPI layer:

| Column | Description |
| --- | --- |
| `is_fixed_spend` | Flags recurring or contract-based outgoings. |
| `spend_rhythm` | Human-friendly label for fixed vs. variable spend. |
| `spend_necessity` | Essentials vs. discretionary split for budgeting. |
| `monthly_net_amount` | Net inflow/outflow per user-month. |
| `category_month_share` | Share-of-wallet for each category within a month. |

## Next steps

- Hook the generator up to bank/CSV ingestion pathways.
- Extend insights for savings rate, budgets, and proactive alerting.
- Add multi-user segmentation with household and cohort comparisons.
- Explore retrieval-augmented LLM summaries grounded in historic trends.
